---
title: "simulation"
output: 
  md_document
---

## Simulation 
Use EwE estimated landings and Beaufort Assessment Model outputs to simulate landings at age data.

```{r, warning = FALSE, message = FALSE, fig.height = 6, echo=FALSE}
library(here)
set.seed(999)

# specify working directories ---------------------------------------------

project_path <- here::here()
ewe_output_path <- file.path(project_path, "data", "ewe_output")
menhadenSA_output_path <- file.path(project_path, "data", "AtlanticMenhadenSA")

# read Atlantic menhaden Beaufort Assessment Model output data into an R object --------

menhadenSA_output <- dget(file.path(menhadenSA_output_path, "am019.rdat"))

# functional groups information -------------------------------------------
# Get information from the Ecopath basic input table
group_name <- c(
  "StripedBass0",
  "StripedBass2_5",
  "StripedBass6+",
  "AtlanticMenhadenJuvenile",
  "AtlanticMenhadenAdult",
  "SpinyDogfish",
  "BluefishJuvenile",
  "BluefishAdult",
  "WeakfishJuvenile",
  "WeakfishAdult",
  "AtlanticHerring0_1",
  "AtlanticHerring2+",
  "Anchovies",
  "Benthos",
  "Zooplankton",
  "Phytoplankton",
  "Detritus"
)

functional_groups <- data.frame(
  group_name = group_name,
  ewe_code = paste0("X", 1:length(group_name)),
  ewe_name = c(
    "striped bass 0",
    "striped bass 2-5",
    "striped bass 6+",
    "menhaden juv",
    "menhaden adult",
    "spiny dogfish",
    "bluefish juv",
    "bluefish adult",
    "weakfish juv",
    "weakfish adult",
    "Atlantic herring 0-1",
    "Atlantic herring 2+",
    "anchovies",
    "benthos",
    "zooplankton",
    "phytoplankton",
    "Detritus"
  )
)

menhaden_juvenile_code <- functional_groups$ewe_code[functional_groups$group_name == "AtlanticMenhadenJuvenile"]

menhaden_adult_code <- functional_groups$ewe_code[functional_groups$group_name == "AtlanticMenhadenAdult"]

# generate true landings and landings age composition data using EwE and BAM output data  --------------------------------------

# read annual landings (need to remove information of EwE run from the csv table)
annual_landings <- read.csv(file.path(ewe_output_path, "catch_annual.csv"))

ewe_years <- annual_landings$year.group
menhaden_juvenile_landings <- annual_landings[, menhaden_juvenile_code] * 1000 # in mt
menhaden_adult_landings <- annual_landings[, menhaden_adult_code] * 1000 # in mt
menhaden_total_landings <- menhaden_juvenile_landings + menhaden_adult_landings

# plot observed total catch of menhaden from BAM assessment v.s. menhaden adult catch from EwE
sa_year_id <- which(menhadenSA_output$t.series$year %in% ewe_years)

# BAM assessment includes landings from commercial reduction fishery-north (cRn), commercial reduction fishery-south (cRs), commercial bait fishery-north (cBn), and commercial bait fishery-south (cBs), the age composition data follow dirichlet-multinomial overdispersion parameter (log space)

# generate true landings age composition data
model_ages <- as.character(0:6)
ages <- as.character(1:6)
sa_Lagecomp_probs <- menhadenSA_output$L.age.pred.mt[sa_year_id, ages] / sum(menhadenSA_output$L.age.pred.mt[sa_year_id, ages])

# Lagecomp_dirichletMultinomial <- MGLM::rdirmn(
#   n = length(ewe_years),
#   size = menhaden_adult_landings,
#   alpha = sa_Lagecomp_probs
# ) # Many 0s

Lagecomp_true <- matrix(NA, nrow = length(ewe_years), ncol = length(model_ages))
colnames(Lagecomp_true) <- model_ages

Lagecomp_probs_true <- matrix(NA, nrow = length(ewe_years), ncol = length(model_ages))
colnames(Lagecomp_probs_true) <- model_ages

Lagecomp_true[, 1] <- menhaden_juvenile_landings
for (i in 1:nrow(Lagecomp_true)) {
  Lagecomp_true[i, ages] <- rmultinom(
    n = 1,
    size = menhaden_adult_landings[i],
    prob = sa_Lagecomp_probs[i, ]
  )

  Lagecomp_probs_true[i, ] <- Lagecomp_true[i, ] / sum(Lagecomp_true[i, ])
}

# generate observed landings and landings age composition data  --------

# observed landings
fishery_name <- c("cRn", "cRs", "cBn", "cBs")
sa_cvL <- data.frame(
  cRn_CV = rep(NA, length(ewe_years)),
  cRs_CV = rep(NA, length(ewe_years)),
  cBn_CV = rep(NA, length(ewe_years)),
  cBs_CV = rep(NA, length(ewe_years))
)

for (i in 1:length(fishery_name)){
  sa_cvL[, paste0(fishery_name[i], "_CV")] <- menhadenSA_output$t.series[sa_year_id, paste0("cv.L.", fishery_name[[i]])]
}

cvL <- apply(sa_cvL, 1, mean) #0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.070 0.045 0.045 0.045 0.045 0.045
L_obs <- c()
for(i in 1:length(ewe_years)){

  sdL <- sqrt(log(1+cvL[i]^2)) #SD in log space, given CV in arithmetic space
  lnL <- rnorm(1, mean=0, sd=sdL) #log error
  L_obs[i] <- menhaden_total_landings[i]*exp(lnL) #multiplicative lognormal error

}

par(mfrow=c(1,1))
yrange <- range(menhaden_total_landings, menhadenSA_output$t.series$total.L.mt[sa_year_id], L_obs)
plot(annual_landings$year.group, menhaden_total_landings,
     xlab = "Years", ylab = "Landings (mt)",
     type = "l", lty = 1
)
lines(menhadenSA_output$t.series$year[sa_year_id], menhadenSA_output$t.series$total.L.mt[sa_year_id], lty = 2)
lines(annual_landings$year.group, L_obs, lty = 3)

legend("topright",
       c("EwE_true", "BAM", "EwE_obs_err"),
       lty = c(1, 2, 3),
       bty = "n"
)

# sampling of age composition
nsampleL <- rep(200, nrow(Lagecomp_true))

Lagecomp_obs <- matrix(NA, nrow = length(ewe_years), ncol = length(model_ages))
colnames(Lagecomp_obs) <- model_ages

for (i in 1:nrow(Lagecomp_true)){
  if(sum(Lagecomp_true[i,])==0) {
    probs <- rep(0, length(Lagecomp_true[i,]))
    Lagecomp_obs[i,] <- rep(0, length(Lagecomp_true[i,]))
  } else {
    probs <- Lagecomp_true[i,]/sum(Lagecomp_true[i,])
    Lagecomp_obs[i,] <- rmultinom(n=1, size=nsampleL[i], prob=probs)/nsampleL[i]
  }
}

par(mfrow = c(3, 3))
for (i in 1:nrow(Lagecomp_true)) {
  yrange <- range(Lagecomp_true[i, ], menhadenSA_output$L.age.pred.mt[sa_year_id[i], ])
  plot(model_ages, Lagecomp_true[i, ],
       ylim = yrange,
       type = "l",
       ylab = "Age comp", xlab = "Ages"
  )
  points(model_ages, menhadenSA_output$L.age.pred.mt[sa_year_id[i], ])
  par(new = TRUE)
  plot(model_ages, Lagecomp_obs[i, ],
       xlab = "", ylab = "",
       type="l", lty=2, axes=F,
       col="blue")
  axis(side = 4, at = pretty(range(Lagecomp_obs[i, ])), col="blue")
  legend("topright",
         c("EwE_true", "BAM", "EwE_obs_err"),
         title = ewe_years[i],
         lty = c(1, NA, 1),
         pch = c(NA, 1, NA),
         bty = "n",
         cex = 0.8
  )
}




```

